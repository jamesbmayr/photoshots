<!DOCTYPE html>
<html>
	<head>
		<script node>getAsset("logo")</script node>
		<script node>getAsset("meta")</script node>
		<script node>getAsset("fonts")</script node>
		<script node>getAsset("css-variables")</script node>
		<link rel="stylesheet" href="game.css"/>
		<script src="qrcode-generator.js" defer></script>
		<script src="qrcode-reader.js" defer></script>
		<script src="game.js" defer></script>
	</head>
	<body>
		<a id="home-link" href="/">home</a>
		<div id="actions">
			<script node>
				if (!REQUEST.game.timeEnd && REQUEST.session.userId && REQUEST.game.players[REQUEST.session.userId]) {
					`<button id="quit-game-button">quit game</button>`
				}
			</script node>
			<script node>
				if (!REQUEST.game.timeEnd && REQUEST.session.userId && REQUEST.game.ownerId == REQUEST.session.userId) {
					`<button id="delete-game-button">delete game</button>`
				}
			</script node>
			<script node>
				if (!REQUEST.game.timeStart && REQUEST.session.userId && REQUEST.game.ownerId == REQUEST.session.userId) {
					`<button id="start-game-button">start game</button>`
				}
			</script node>
		</div>
		<div id="container">
			<h1><script node>REQUEST.game.id</script node></h1>
			<div id="qr-code">
				<h2>QR Code</h2>
				<button id="qr-code-print-button">print QR Code</button>
				<div id="qr-code-container"><script node>REQUEST.game.id</script node></div>
			</div>
			<div id="game-state">
				<h2>state</h2>
				<div id="game-state-indicator">
					<script node>REQUEST.game.timeEnd ? `ended ${new Date(REQUEST.game.timeEnd).toLocaleString()}` : REQUEST.game.timeRemaining ? convertTime(REQUEST.game.timeRemaining) : `setting up`</script node>
				</div>
			</div>
			<div id="game-mode">
				<h2>mode</h2>
				<li id="game-mode-name">
					<script node>
						const gameModes = getAsset("constants").gameModes;
						`<select id="game-mode-select"${REQUEST.game.timeStart || !REQUEST.session.userId || REQUEST.game.ownerId !== REQUEST.session.userId ? " disabled" : ""}>` +
							Object.keys(gameModes).map(gameModeId => 
								`<option value="${gameModeId}"${gameModeId == REQUEST.game.mode.id ? " selected" : ""}>${gameModes[gameModeId].name}</option>`
							).join("\n") +
						`</select>`
					</script node>
				</li>
				<li id="game-mode-win-condition"><script node>REQUEST.game.mode.winCondition || "?"</script node></li>
				<li id="game-mode-end-condition"><script node>REQUEST.game.mode.endCondition || "?"</script node></li>
			</div>
			<div id="players">
				<h2>players</h2>
				<div id="players-list">
					<script node>
						Object.keys(REQUEST.game.players).map(playerId => {
							const player = REQUEST.game.players[playerId]
							const status = REQUEST.game.timeEnd ? (player.win ? "win" : player.loss ? "loss" : "unknown") :
										   !player.connected ? "disconnected" :
										   REQUEST.game.timeStart ? (player.cooldown ? `stunned (${player.cooldown})` : (player.target ? "in" : "out")) :
										   "ready"
							return `<div class="player" id="player-${playerId}"${playerId == REQUEST.session.userId ? " self=true" : ""}>` +
									`<h3 class="player-name">${player.name}</h3>` +
									`<h4 class="player-status">${status}</h4>` +
									`<li class="player-stat">` +
										`<span>target</span>` +
										`<span class="player-stat-target">${player.target ? REQUEST.game.players[player.target].name : "-"}<span>` +
									`</li>` +
									`<li class="player-stat">` +
										`<span>shots</span>` +
										`<span class="player-stat-shots">${player.shots}<span>` +
									`</li>` +
									`<li class="player-stat">` +
										`<span>stuns</span>` +
										`<span class="player-stat-stuns">${player.stuns}<span>` +
									`</li>` +
									`<li class="player-stat">` +
										`<span>time in</span>` +
										`<span class="player-stat-time-in">${convertTime(player.timeIn)}<span>` +
									`</li>` +
									`<li class="player-stat">` +
										`<span>time out</span>` +
										`<span class="player-stat-time-out">${convertTime(player.timeOut)}<span>` +
									`</li>` +
								`</div>`
						}).join(`\n`)
					</script node>
				</div>
			</div>
		</div>
		<div id="reader"></div>
	</body>
</html>
